@if (!isDrawer() && isEditingContact) {
  <ng-container
    *ngTemplateOutlet="formTemplate">
  </ng-container>
}

<app-drawer
  #contactDrawer
  placement="right"
  size="xl"
  [beforeClose]="canClose.bind(this)"
  [hasCustomContent]="true"
  (onClose)="onFormClose($event)">
  <ng-container drawer-header>
    <h2 class="text-lg font-black leading-5 text-main-blue1h">
      Información de contacto
    </h2>
  </ng-container>

  @if (isDrawer() && isEditingContact) {
    <div drawer-custom-content class="flex-1 min-h-0">
      <ng-container
        *ngTemplateOutlet="formTemplate">
      </ng-container>
    </div>
  }
</app-drawer>


<ng-template #formTemplate>
  @if (loading) {
    <div class="absolute inset-0 z-50 bg-gray-50/60 flex items-center justify-center">
      <svg class="w-7 h-7 text-main-blue1h animate-spin fill-gray-200">
        <use xlink:href="/assets/icons/extras/animations.svg#spin" />
      </svg>
    </div>
  }

  <form [formGroup]="contactForm" (ngSubmit)="onSubmit()" class="h-full flex flex-col"
    [ngClass]="{ 'gap-4': !isDrawer() }">
    @if (!isDrawer()) {
      <div class="flex flex-col sm:flex-row justify-between gap-2">
        <app-button
          (onClick)="close()"
          variant="primary"
          styleType="ghost"
          size="sm"
          customClass="leading-4">
          <svg width="16" height="16">
            <use xlink:href="/assets/icons/outline/arrows.svg#chevron-left" />
          </svg>
          Volver a contactos
        </app-button>
        <div class="flex gap-2 w-full sm:w-auto">
          <app-button
            [type]="'submit'"
            variant="primary"
            styleType="solid"
            size="xs"
            class="flex-1"
            customClass="w-full flex justify-center">
            Guardar
          </app-button>
          <app-button
            (onClick)="close()"
            variant="primary"
            styleType="soft"
            size="xs"
            class="flex-1"
            customClass="w-full flex justify-center">
            Cancelar
          </app-button>
        </div>
      </div>
    }

    <div [ngClass]="{ 'p-6 overflow-y-auto flex-1': isDrawer() }">
      <div class="flex flex-col p-4 rounded-xl"
        [ngClass]="{
          'gap-4 bg-gray-50 ring-[1px] ring-inset ring-gray-200': isDrawer(),
          'gap-6 bg-gray-100': !isDrawer()
        }">

        <div class="flex flex-col gap-2">
          <div>
            <app-select
              [items]="contactOccupationTypes"
              bindLabel="type"
              bindValue="idOccupationType"
              formControlName="idOccupationType"
              placeholder="* Tipo de contacto">
            </app-select>
            <app-input-error [control]="contactForm.get('idOccupationType')" />
          </div>
          <div>
            <app-select
              [items]="contactOccupations"
              bindLabel="occupation"
              bindValue="idOccupation"
              formControlName="idOccupation"
              [searchable]="true"
              [placeholder]="selectedOccupationType === 1 ? '* Seleccionar área' : '* Cargo'">
            </app-select>
            <app-input-error [control]="contactForm.get('idOccupation')" />
          </div>
          @if (selectedOccupationType === 2) {
            <div>
              <app-text-input
                [id]="'contactName'"
                label="* Nombre"
                formControlName="name"
              />
              <app-input-error [control]="contactForm.get('name')" />
            </div>
          }
          @if (identificationEnabled) {
            <div>
              <app-select
                [items]="identificationTypes"
                bindLabel="typeDocument"
                bindValue="idTypeDocument"
                formControlName="idTypeDocument"
                placeholder="* Tipo de identificación">
              </app-select>
              <app-input-error [control]="contactForm.get('idTypeDocument')" />
            </div>
            <div>
              <app-text-input
                [id]="'identification'"
                label="* Identificación"
                formControlName="identification"
              />
              <app-input-error [control]="contactForm.get('identification')" />
            </div>
            <div>
              <app-text-input
                [id]="'expeditionDate'"
                label="* Fecha de expedición"
                [type]="'date'"
                [maxDate]="todayDate"
                formControlName="expeditionDate"
              />
              <app-input-error [control]="contactForm.get('expeditionDate')" />
            </div>
            <div>
              <app-select
                [items]="cities"
                [bindLabel]="cityLabel"
                bindValue="idCity"
                formControlName="idCityExpedition"
                [searchable]="true"
                placeholder="* Ciudad de expedición">
              </app-select>
              <app-input-error [control]="contactForm.get('idCityExpedition')" />
            </div>
          }
        </div>

        <div class="flex flex-col gap-2" formArrayName="Emails">
          <div class="flex items-center justify-between">
            <h4 class="text-base font-semibold leading-[18px]">Correos</h4>
            <app-button
              (onClick)="addEmail()"
              [disabled]="emailsArray.length >= 5"
              variant="primary"
              styleType="soft"
              size="sm"
              customClass="leading-4"
              [ngClass]="{ 'hidden sm:block': isDrawer() }">
              <svg width="16" height="16">
                <use xlink:href="/assets/icons/outline/general.svg#plus" />
              </svg>
              Agregar
            </app-button>
          </div>
          @for (control of emailsArray.controls; track control; let i = $index) {
            <div [formGroupName]="i">
              <div class="flex items-center gap-2">
                <div class="flex-1">
                  <app-text-input
                    [id]="'email-' + i"
                    label="* Correo"
                    formControlName="email"
                  />
                </div>
                @if (canRemoveEmail) {
                  <app-tooltip
                    [id]="'remove-email-' + i"
                    [text]="'Eliminar correo'"
                    position="left"
                    styleType="dark">
                    <app-button
                      (onClick)="removeEmail(i)"
                      variant="red"
                      styleType="soft"
                      size="sm">
                      <svg width="20" height="20">
                        <use xlink:href="/assets/icons/outline/general.svg#minus" />
                      </svg>
                    </app-button>
                  </app-tooltip>
                }
              </div>
              <app-input-error [control]="control.get('email')" />
            </div>
          }
          @if (isDrawer() && emailsArray.length < 5) {
            <app-button
              (onClick)="addEmail()"
              [disabled]="emailsArray.length >= 5"
              variant="primary"
              styleType="soft"
              size="sm"
              class="block sm:hidden"
              customClass="leading-4 w-full flex justify-center">
              <svg width="16" height="16">
                <use xlink:href="/assets/icons/outline/general.svg#plus" />
              </svg>
              Agregar
            </app-button>
          }
        </div>

        <div class="flex flex-col gap-2" formArrayName="Phones">
          <div class="flex items-center justify-between">
            <h4 class="text-base font-semibold leading-[18px]">Teléfonos</h4>
            <app-button
              (onClick)="addPhone()"
              [disabled]="phonesArray.length >= 5"
              variant="primary"
              styleType="soft"
              size="sm"
              customClass="leading-4"
              [ngClass]="{ 'hidden sm:block': isDrawer() }">
              <svg width="16" height="16">
                <use xlink:href="/assets/icons/outline/general.svg#plus" />
              </svg>
              Agregar
            </app-button>
          </div>
          @for (control of phonesArray.controls; track control; let i = $index) {
            <div [formGroupName]="i" class="flex flex-col gap-2">
              <div>
                <app-select
                  [items]="phoneNumberTypes"
                  formControlName="type"
                  placeholder="* Tipo">
                </app-select>
                <app-input-error [control]="control.get('type')" />
              </div>
              @if (isFijoPhone(control)) {
                <div>
                  <app-select
                    [items]="cities"
                    [bindLabel]="cityLabelWithIndicative"
                    bindValue="idCity"
                    formControlName="idCity"
                    [searchable]="true"
                    placeholder="* Indicativo">
                  </app-select>
                  <app-input-error [control]="control.get('idCity')" />
                </div>
              }
              <div>
                <app-text-input
                  [id]="'number-' + i"
                  label="* Número"
                  formControlName="number"
                />
                <app-input-error
                  [control]="control.get('number')"
                  [customMessages]="customErrorMessagesMap['phoneNumber']"
                />
                @if (isFijoPhone(control)) {
                  <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                    El indicativo se toma del campo superior, no lo escribas manualmente.
                  </p>
                }
              </div>
              <div>
                <app-text-input
                  [id]="'extension-' + i"
                  label="Extensión - Opcional"
                  formControlName="extension"
                />
                <app-input-error [control]="control.get('extension')" />
              </div>
              @if (canRemovePhone) {
                <app-button
                  (onClick)="removePhone(i)"
                  variant="red"
                  styleType="soft"
                  size="xs"
                  customClass="w-full flex justify-center">
                  <svg width="16" height="16">
                    <use xlink:href="/assets/icons/outline/general.svg#minus" />
                  </svg>
                  Eliminar teléfono
                </app-button>
              }
            </div>
          }
          @if (isDrawer() && phonesArray.length < 5) {
            <app-button
              (onClick)="addPhone()"
              [disabled]="phonesArray.length >= 5"
              variant="primary"
              styleType="soft"
              size="sm"
              class="block sm:hidden"
              customClass="leading-4 w-full flex justify-center">
              <svg width="16" height="16">
                <use xlink:href="/assets/icons/outline/general.svg#plus" />
              </svg>
              Agregar
            </app-button>
          }
        </div>

      </div>
    </div>

    @if (isDrawer()) {
      <div class="border-t p-6 shadow-2xl flex flex-col-reverse sm:flex-row gap-4">
        <app-button
          (onClick)="close()"
          variant="gray"
          styleType="soft"
          size="lg"
          class="flex-1"
          customClass="leading-[18px] w-full flex justify-center">
          Cancelar
        </app-button>
        <app-button
          [type]="'submit'"
          variant="primary"
          styleType="solid"
          size="lg"
          class="flex-1"
          customClass="leading-[18px] w-full flex justify-center">
          Guardar
        </app-button>
      </div>
    }
  </form>

</ng-template>



