@if (loading) {
  <div class="absolute inset-0 z-50 bg-gray-50/60 flex items-center justify-center">
    <svg class="w-7 h-7 text-main-blue1h animate-spin fill-gray-200">
      <use xlink:href="/assets/icons/extras/animations.svg#spin" />
    </svg>
  </div>
}

<div class="flex justify-center mx-4">
  <div class="max-w-screen-md w-full pt-10 pb-20 md:pt-6 flex flex-col gap-3">

    <app-button
      (onClick)="goBack()"
      variant="primary"
      styleType="ghost"
      size="sm"
      customClass="leading-4">
      <svg width="16" height="16">
        <use xlink:href="/assets/icons/outline/arrows.svg#chevron-left" />
      </svg>
      Volver
    </app-button>

    @if (isFirstForm) {
      <app-alert
        variant="info"
        [closable]="true"
        [title]="'Para guardar la información y reflejar los cambios, asegúrate de completar todas las secciones del formulario.'"
        customIconPath="/assets/icons/outline/general.svg#check-circle">
      </app-alert>
    } @else {
      @if (eventManager.isEditingProvider()) {
        <app-alert
          variant="info"
          [closable]="true"
          [title]="'Confirma que los datos que modificaste estén correctos antes de actualizar la información.'"
          customIconPath="/assets/icons/outline/general.svg#check-circle">
        </app-alert>
      } @else {
        <app-alert
          variant="dark"
          [closable]="true"
          [title]="'Recuerda mantener la información actualizada para que los datos guardados se reflejen correctamente.'"
          customIconPath="/assets/icons/outline/general.svg#check-circle">
        </app-alert>
      }
    }

    <div class="flex flex-col gap-6">
      @if (isFirstForm) {
        <div>
          <div class="text-right text-xs font-medium text-gray-500">
            {{ progressPercentage | number:'1.0-0' }}%
          </div>
          <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700">
            <div class="bg-main-blue1h h-1.5 rounded-full transition-all duration-300 ease-in-out"
              [style.width.%]="progressPercentage">
            </div>
          </div>
        </div>
      }

      <div class="flex flex-col md:flex-row gap-4">

        <!-- Desktop navigation -->
        <div class="hidden md:flex flex-col gap-4">
          <div class="flex flex-col gap-1">
            @for (step of steps; track step.key) {
              <app-button
                variant="primary"
                [styleType]="step.key === activeStep ? 'soft' : 'ghost'"
                size="sm"
                customClass="w-full leading-4"
                [disabled]="!step.enabled"
                (onClick)="goToStep(step.key)">
                <svg width="16" height="16">
                  <use [attr.xlink:href]="step.icon" />
                </svg>
                {{ step.label }}
              </app-button>
            }
          </div>
          <div class="flex flex-col gap-4 p-4 rounded-xl bg-blue3h-100 w-[245px]">
            <div class="relative w-[161.6px] h-[220px] mx-auto">
              <img src="assets/img/pqrs/banner.png" alt="Imagen soporte"
              class="w-full h-full object-cover">
              <div class="absolute inset-0 bg-gradient-to-t from-blue3h-100 from-[1%] via-blue3h-100/0 to-transparent to-[75%]"></div>
            </div>
            <span class="text-sm font-semibold leading-4">
              Canal de atención para preguntas, sugerencias o reclamos.
            </span>
            <app-button
              [routerLink]="'/support'"
              variant="primary"
              styleType="solid"
              size="md"
              customClass="w-full flex justify-center leading-4">
              Ir al canal
            </app-button>
          </div>
        </div>

        <!-- Mobile navigation -->
        <div class="flex gap-2 md:hidden h-8">
          @if (!atStart) {
            <app-button
              variant="primary"
              styleType="ghost"
              size="sm"
              (onClick)="scrollStep('left')"
              customClass="h-full !p-2">
              <svg width="24" height="24">
                <use xlink:href="/assets/icons/outline/arrows.svg#chevron-double-left" />
              </svg>
            </app-button>
          }

          <!-- Scrollable container on mobile -->
          <div #stepsContainer
            class="flex-1 flex gap-1 overflow-x-auto scrollbar-hide scroll-smooth whitespace-nowrap rounded-xl min-w-0">
            @for (step of steps; track step.key) {
              <div>
                <app-button
                  variant="primary"
                  [styleType]="step.key === activeStep ? 'soft' : 'ghost'"
                  size="sm"
                  customClass="flex-shrink-0 min-w-[120px] leading-4"
                  [disabled]="!step.enabled"
                  (onClick)="goToStep(step.key, false)">
                  <svg width="16" height="16">
                    <use [attr.xlink:href]="step.icon" />
                  </svg>
                  {{ step.label }}
                </app-button>
              </div>
            }
          </div>

          @if (!atEnd) {
            <app-button
              variant="primary"
              styleType="ghost"
              size="sm"
              (onClick)="scrollStep('right')"
              customClass="h-full !p-2">
              <svg width="24" height="24">
                <use xlink:href="/assets/icons/outline/arrows.svg#chevron-double-right" />
              </svg>
            </app-button>
          }
        </div>

        <div class="flex-1 min-w-0 flex flex-col gap-4">
          @switch (activeStep) {
            @case ('provider') {
              <app-provider-form
                [isFirstForm]="isFirstForm"
                [form]="providerForm"
                [providerFormFields]="providerFormFields"
                [identificationTypes]="identificationTypes"
                [validateProviderForm]="validateProviderForm.bind(this)"
                (clearSectionBackendError)="clearSectionBackendError()"
                (next)="goToStep('offices', true)"
                (save)="onSubmit()">
              </app-provider-form>
            }
            @case ('offices') {
              <app-office-list
                [isFirstForm]="isFirstForm"
                [providerCompanies]="providerCompanies"
                [createdOffices]="createdOffices"
                [updatedOffices]="updatedOffices"
                [deletedOffices]="deletedOffices"
                [existingOffices]="existingOffices"
                (officesChanged)="onOfficesChanged($event)"
                (prev)="goToStep('provider')"
                (next)="goToStep('contacts', true)"
                (save)="onSubmit()">
              </app-office-list>
            }
            @case ('contacts') {
              <app-contact-list
                [isFirstForm]="isFirstForm"
                [createdContacts]="createdContacts"
                [updatedContacts]="updatedContacts"
                [deletedContacts]="deletedContacts"
                [existingContacts]="existingContacts"
                (contactsChanged)="onContactsChanged($event)"
                (prev)="goToStep('offices')"
                (save)="onSubmit()">
              </app-contact-list>
            }
          }

          <app-backend-errors
            [error]="backendError"
            [grouped]="false">
          </app-backend-errors>
        </div>
      </div>
    </div>


  </div>
</div>


<!-- <button nz-button nzType="primary" type="button" (click)="openOfficeModal(getGlobalIndex(i, officePage, officePageSize))" nz-tooltip nzTooltipTitle="Actualizar"><span nz-icon nzType="edit"></span></button>
<button nz-button nzDanger nzType="primary" type="button" (click)="deleteOffice(getGlobalIndex(i, officePage, officePageSize))" nz-tooltip nzTooltipTitle="Eliminar"><span nz-icon nzType="delete"></span></button> -->

<!-- <button nz-button nzType="primary" type="button" (click)="openContactModal(getGlobalIndex(i, contactPage, contactPageSize))" nz-tooltip nzTooltipTitle="Actualizar"><span nz-icon nzType="edit"></span></button>
<button nz-button nzDanger nzType="primary" type="button" (click)="deleteContact(getGlobalIndex(i, contactPage, contactPageSize))" nz-tooltip nzTooltipTitle="Eliminar"><span nz-icon nzType="delete"></span></button> -->
