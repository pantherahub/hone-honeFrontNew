<app-drawer
  #rateDrawer
  placement="right"
  size="xl"
  (onClose)="onDrawerClose()"
  [hasFooter]="showFooter">
  <ng-container drawer-header>
    <h2 class="block sm:hidden text-lg font-black leading-5 text-main-blue1h">
      Tarifas
    </h2>
    <h2 class="hidden sm:block text-lg font-black leading-5 text-main-blue1h">
      {{ selectedRate?.currentRate?.nameFile || 'Tarifas' }}
    </h2>
  </ng-container>

  @if (selectedRate) {
    <form [formGroup]="rateForm" class="flex flex-col gap-6">
      <div class="flex gap-6">
        <div class="flex-1 flex flex-col gap-2.5 text-sm leading-4">
          <span class="font-semibold text-gray-900">Fecha de carga</span>
          <span class="text-gray-500">
            {{ selectedRate.currentRate.dateAdd | date: 'mediumDate' }}
          </span>
        </div>
        <div class="flex-1 flex flex-col gap-2.5 text-sm leading-4">
          <span class="font-semibold text-gray-900">Última modificación</span>
          <span class="text-gray-500">
            {{ selectedRate.currentRate.updateAt | date: 'mediumDate' }}
          </span>
        </div>
      </div>

      @if (isProcessing) {
        <div class="flex flex-col gap-2.5 text-sm leading-4">
          <span class="font-semibold text-gray-900">En proceso de validación</span>
          <p class="text-gray-500">
            Tu tarifa ha sido enviada y está siendo revisada. Recibirás una notificación cuando sea aprobada o si requiere correcciones.
          </p>
        </div>
      } @else if (isRejected && selectedRate.currentRate?.reportDescription) {
        <div class="flex flex-col gap-2.5 text-sm leading-4">
          <span class="font-semibold text-gray-900">Reporte</span>
          <p class="text-gray-500">
            {{ selectedRate.currentRate.reportDescription }}
          </p>
        </div>
      }

      <div class="flex flex-col gap-4 p-4 bg-gray-50 rounded-xl ring-[1px] ring-inset ring-gray-200">
        <div class="flex flex-col gap-2.5">
          <span class="text-sm font-semibold leading-4 text-gray-900">
            @if (isPending || !selectedRate.rateHistory) {
              Tarifa {{ selectedRate.rateName }}
            } @else {
              Actual
            }
          </span>

          <div class="p-4 flex flex-col sm:flex-row sm:items-center gap-2 rounded-md ring-[1px] ring-inset ring-gray-200">

            <div class="flex-1 flex items-center gap-2">
              <div class="rounded-lg p-3 bg-blue1h-50 text-main-blue1h">
                <svg width="20" height="20">
                  <use xlink:href="/assets/icons/outline/files-folders.svg#file-lines" />
                </svg>
              </div>
              @if (isPending) {
                <div class="flex-1 flex flex-col gap-1 text-gray-900 text-sm leading-4 min-w-0">
                  @if (selectedFile) {
                    <span class="font-semibold truncate block">
                      {{ selectedFile.name }}
                    </span>
                    <span>{{ selectedFile.size | formatFileBytes }}</span>
                  }
                </div>
              } @else {
                <div class="flex-1 flex flex-col gap-1 text-gray-900 text-sm leading-4 min-w-0">
                  <span class="font-semibold truncate block">
                    {{ selectedRate.currentRate.nameFile }}
                  </span>
                  <span>{{ selectedRate.currentRate.fileSize }}</span>
                </div>
              }

              <!-- Mobile options -->
              <div class="block sm:hidden">
                @if (isPending) {
                  @if (selectedFile) {
                    <button (click)="clearFile()" class="p-0.5 text-gray-500 bg-transparent hover:text-gray-950">
                      <svg width="16" height="16">
                        <use xlink:href="/assets/icons/outline/general.svg#close" />
                      </svg>
                    </button>
                  } @else {
                    <app-button
                      variant="primary"
                      styleType="solid"
                      size="xs"
                      (onClick)="triggerFileInput()">
                      <svg width="16" height="16">
                        <use xlink:href="/assets/icons/outline/general.svg#upload" />
                      </svg>
                    </app-button>
                  }
                } @else if (isApproved) {
                  <app-button
                    variant="gray"
                    styleType="soft"
                    size="xs">
                    <svg width="16" height="16">
                      <use xlink:href="/assets/icons/outline/general.svg#download" />
                    </svg>
                  </app-button>
                } @else if (isRejected) {
                  <app-button
                    appDropdownTrigger="dropdown-rate-opts"
                    dropdownPlacement="bottom-end"
                    variant="gray"
                    styleType="soft"
                    size="xs">
                    <svg width="16" height="16">
                      <use xlink:href="/assets/icons/outline/general.svg#dots-horizontal" />
                    </svg>
                  </app-button>
                  <div id="dropdown-rate-opts" class="z-50 hidden bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700 dark:divide-gray-600">
                    <ul class="py-1 text-sm text-gray-700 dark:text-gray-200">
                      <li>
                        <a (click)="triggerFileInput()" data-dropdown-close class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">
                          <svg width="18" height="18" class="text-gray-500">
                            <use xlink:href="/assets/icons/outline/general.svg#upload" />
                          </svg>
                          Cargar
                        </a>
                      </li>
                      <li>
                        <a (click)="downloadReport()" data-dropdown-close class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">
                          <svg width="18" height="18" class="text-gray-500">
                            <use xlink:href="/assets/icons/outline/general.svg#download" />
                          </svg>
                          Descargar reporte
                        </a>
                      </li>
                    </ul>
                  </div>
                }
              </div>
            </div>

            @if (!isPending) {
              <span class="block sm:hidden text-sm leading-4 text-gray-500">
                Cargado: {{ selectedRate.currentRate.dateAdd }}
              </span>
            }
            @if (!isPending || (isPending && !selectedFile)) {
              <ng-container
                *ngTemplateOutlet="rateStatusTemplate; context: { rate: selectedRate.currentRate }">
              </ng-container>
            }

            <!-- Desktop options -->
            <div class="hidden sm:flex items-center gap-2">
              @if (isPending && selectedFile) {
                <button (click)="clearFile()" class="p-0.5 text-gray-500 bg-transparent hover:text-gray-950">
                  <svg width="16" height="16">
                    <use xlink:href="/assets/icons/outline/general.svg#close" />
                  </svg>
                </button>
              }
              @if (isRejected || (isPending && !selectedFile)) {
                <app-button
                  variant="primary"
                  styleType="solid"
                  size="xs"
                  (onClick)="triggerFileInput()">
                  <svg width="16" height="16">
                    <use xlink:href="/assets/icons/outline/general.svg#upload" />
                  </svg>
                  Cargar
                </app-button>
                <input
                  #fileInput
                  appFileSelect
                  type="file"
                  name="file"
                  class="hidden"
                  (fileValidated)="uploadRateFile($event)"
                />
              }
              @if (isApproved || isRejected) {
                <app-button
                  (onClick)="downloadReport()"
                  variant="gray"
                  styleType="soft"
                  size="xs">
                  <svg width="16" height="16">
                    <use xlink:href="/assets/icons/outline/general.svg#download" />
                  </svg>
                </app-button>
              }
            </div>
          </div>

          @if (!isPending && selectedRate.rateHistory) {
            <div class="xs:ps-3 flex gap-4 max-w-full">
              <div class="hidden xs:block w-[3px] rounded-3xl bg-gray-200"></div>
              <div class="flex-1 flex flex-col gap-2.5 max-w-full">
                <span class="text-sm font-semibold leading-4 text-gray-900">
                  Historial
                </span>
                @for (prevRate of selectedRate.rateHistory; track $index) {
                  <div class="p-4 flex flex-col sm:flex-row sm:items-center gap-2 rounded-md ring-[1px] ring-inset ring-gray-200 bg-white">

                    <div class="flex-1 flex items-center gap-2">
                      <div class="rounded-lg p-3 bg-blue1h-50 text-main-blue1h">
                        <svg width="20" height="20">
                          <use xlink:href="/assets/icons/outline/files-folders.svg#file-lines" />
                        </svg>
                      </div>
                      <div class="flex-1 flex flex-col gap-1 text-gray-900 text-sm leading-4 min-w-0">
                        <span class="font-semibold truncate block">
                          {{ prevRate.nameFile }}
                        </span>
                        <span>{{ prevRate.fileSize }}</span>
                      </div>
                      <app-button
                        class="block sm:hidden"
                        variant="gray"
                        styleType="soft"
                        size="xs">
                        <svg width="16" height="16">
                          <use xlink:href="/assets/icons/outline/general.svg#download" />
                        </svg>
                      </app-button>
                    </div>

                    <div class="sm:text-end text-sm leading-4 text-gray-500">
                      Cargado: <span class="whitespace-nowrap">{{ prevRate.dateAdd }}</span>
                    </div>
                    <ng-container
                      *ngTemplateOutlet="rateStatusTemplate; context: { rate: prevRate }">
                    </ng-container>
                    <app-button
                      class="hidden sm:block"
                      variant="gray"
                      styleType="soft"
                      size="xs">
                      <svg width="16" height="16">
                        <use xlink:href="/assets/icons/outline/general.svg#download" />
                      </svg>
                    </app-button>
                  </div>
                }
              </div>
            </div>
          }
        </div>

      </div>

      @if (isPending) {
        <div class="flex flex-col gap-2.5">
          <label class="text-sm font-semibold leading-4 text-gray-900">Observaciones</label>
          <app-text-input [id]="'observations'" formControlName="observations" label="Escribe aquí tus observaciones" [isTextarea]="true" />
        </div>
      }
    </form>
  }

  @if (showFooter) {
    <ng-container drawer-footer>
      <div class="flex flex-col-reverse sm:flex-row gap-4">
        <app-button
          (onClick)="close()"
          variant="gray"
          styleType="soft"
          size="lg"
          class="flex-1"
          customClass="leading-[18px] w-full flex justify-center">
          Cancelar
        </app-button>
        <app-button
          (onClick)="onSubmit()"
          variant="primary"
          styleType="solid"
          size="lg"
          class="flex-1"
          customClass="leading-[18px] w-full flex justify-center">
          Subir
        </app-button>
      </div>
    </ng-container>
  }

</app-drawer>

<ng-template #rateStatusTemplate let-rate="rate">
  <div
    class="inline-flex justify-center gap-1 py-1.5 px-3 rounded-full text-sm font-semibold leading-4 whitespace-nowrap"
    [ngClass]="[
      statusConfig[rate.rateStatus].bg,
      statusConfig[rate.rateStatus].text
    ]">
    @if (statusConfig[rate.rateStatus].icon) {
      <svg width="16" height="16">
        <use [attr.xlink:href]="'/assets/icons/outline/general.svg#' + statusConfig[rate.rateStatus].icon" />
      </svg>
    }
    {{ statusConfig[rate.rateStatus].label }}
  </div>
</ng-template>
