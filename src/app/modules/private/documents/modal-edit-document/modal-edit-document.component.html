<form [formGroup]="documentForm" (ngSubmit)="submitRequest()" class="flex flex-col gap-5">

  <p class="text-sm font-normal leading-4 text-gray-600">
    Formulario para la {{ isNew ? 'carga' : 'actualización' }} del documento:
    <b>{{ (currentDoc?.typeDocument | formatNameDoc:currentDoc?.idDocumentType)
      || 'No especifica' }}</b>.
  </p>

  <div class="flex flex-col gap-4">

    <!-- Campo Software -->
    @if (isFieldRequiredForDocumentType('software')) {
      <div>
        <app-select
          [items]="suraSoftwareTypes"
          formControlName="software"
          placeholder="Software"
        >
        </app-select>
        <app-input-error [control]="documentForm.get('software')" />
      </div>
    }

    <!-- Campo Fecha de Expedición -->
    @if (isFieldRequiredForDocumentType('dateExpedition')) {
      <div>
        <app-text-input
          [id]="'dateExpedition'"
          label="Fecha de Expedición"
          [type]="'date'"
          formControlName="dateExpedition"
        />
        <app-input-error
          [control]="documentForm.get('dateExpedition')"
          [customMessages]="customErrorMessagesMap['dateExpedition']"
        />
        @if (getExpeditionTooltipContent() && !documentForm.get('dateExpedition')?.hasError('dateExpeditionInvalid')) {
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            {{ getExpeditionTooltipContent() }}
          </p>
        }
      </div>
    }

    <!-- Campo Fecha de Diligenciamiento -->
    @if (isFieldRequiredForDocumentType('dateDiligence')) {
      <div>
        <app-text-input
          [id]="'dateDiligence'"
          label="Fecha de Diligenciamiento"
          [type]="'date'"
          formControlName="dateDiligence"
        />
        <app-input-error [control]="documentForm.get('dateDiligence')" />
      </div>
    }

    <!-- Campo Fecha de Inicio -->
    @if (isFieldRequiredForDocumentType('dateSignature')) {
      <div>
        <app-text-input
          [id]="'dateSignature'"
          label="Fecha de Inicio"
          [type]="'date'"
          formControlName="dateSignature"
        />
        <app-input-error [control]="documentForm.get('dateSignature')" />
      </div>
    }

    <!-- Campo Fecha de Vacunación -->
    @if (isFieldRequiredForDocumentType('dateVaccination')) {
      <div>
        <app-text-input
          [id]="'dateVaccination'"
          label="Fecha de Vacunación"
          [type]="'date'"
          formControlName="dateVaccination"
        />
        <app-input-error [control]="documentForm.get('dateVaccination')" />
      </div>
    }

    <!-- Campo Fecha de Vencimiento -->
    @if (isFieldRequiredForDocumentType('expirationDate')) {
      <div>
        <app-text-input
          [id]="'expirationDate'"
          label="Fecha de Vencimiento"
          [type]="'date'"
          formControlName="expirationDate"
        />
        <app-input-error
        [control]="documentForm.get('expirationDate')"
        [customMessages]="customErrorMessagesMap['expirationDate']" />
      </div>
    }

    <!-- Campo Nombre del Representante Legal -->
    @if (isFieldRequiredForDocumentType('legalRepresentative')) {
      <div>
        <app-text-input
          [id]="'legalRepresentative'"
          formControlName="legalRepresentative"
          label="Nombre del Representante Legal"
        />
        <app-input-error [control]="documentForm.get('legalRepresentative')" />
      </div>
    }

    <!-- Campo Nombre Suplente/s -->
    @if (isFieldRequiredForDocumentType('NameAlternate')) {
      <div>
        <app-text-input
          [id]="'NameAlternate'"
          formControlName="NameAlternate"
          label="Suplente/s"
        />
        <app-input-error [control]="documentForm.get('NameAlternate')" />
      </div>
    }

    <!-- Campo Fecha de Entrega del Documento -->
    @if (isFieldRequiredForDocumentType('documentDeliveryDate')) {
      <div>
        <app-text-input
          [id]="'documentDeliveryDate'"
          label="Fecha de Entrega del Documento"
          [type]="'date'"
          formControlName="documentDeliveryDate"
        />
        <app-input-error [control]="documentForm.get('documentDeliveryDate')" />
      </div>
    }

    <!-- Campo Fecha de Nacimiento -->
    @if (isFieldRequiredForDocumentType('dateOfBirth')) {
      <div>
        <app-text-input
          [id]="'dateOfBirth'"
          label="Fecha de Nacimiento"
          [type]="'date'"
          formControlName="dateOfBirth"
        />
        <app-input-error [control]="documentForm.get('dateOfBirth')" />
      </div>
    }

    <!-- Campo Fecha de Consulta -->
    @if (isFieldRequiredForDocumentType('consultationDate')) {
      <div>
        <app-text-input
          [id]="'consultationDate'"
          label="Fecha de Consulta"
          [type]="'date'"
          formControlName="consultationDate"
        />
        <app-input-error [control]="documentForm.get('consultationDate')" />
      </div>
    }

    <!-- Campo Especialidad Avalada -->
    @if (isFieldRequiredForDocumentType('endorsedSpecialtyDate')) {
      <div>
        <app-text-input
          [id]="'endorsedSpecialtyDate'"
          formControlName="endorsedSpecialtyDate"
          label="Especialidad Avalada"
        />
        <app-input-error [control]="documentForm.get('endorsedSpecialtyDate')" />
      </div>
    }

    <!-- Campo Fecha de Inicio de Vigencia -->
    @if (isFieldRequiredForDocumentType('validityStartDate')) {
      <div>
        <app-text-input
          [id]="'validityStartDate'"
          label="Fecha de Inicio de Vigencia"
          [type]="'date'"
          formControlName="validityStartDate"
        />
        <app-input-error [control]="documentForm.get('validityStartDate')" />
      </div>
    }

    <!-- Campo Fecha de Realización -->
    @if (isFieldRequiredForDocumentType('dateofRealization')) {
      <div>
        <app-text-input
          [id]="'dateofRealization'"
          label="Fecha de Realización"
          [type]="'date'"
          formControlName="dateofRealization"
        />
        <app-input-error [control]="documentForm.get('dateofRealization')" />
      </div>
    }

    <!-- Campo Fecha de Recepción -->
    @if (isFieldRequiredForDocumentType('receptionDate')) {
      <div>
        <app-text-input
          [id]="'receptionDate'"
          label="Fecha de Recepción"
          [type]="'date'"
          formControlName="receptionDate"
        />
        <app-input-error [control]="documentForm.get('receptionDate')" />
      </div>
    }

    <!-- Campo Fecha última dosimetria -->
    @if (isFieldRequiredForDocumentType('lastDosimetryDate')) {
      <div>
        <app-text-input
          [id]="'lastDosimetryDate'"
          label="Fecha última dosimetria"
          [type]="'date'"
          formControlName="lastDosimetryDate"
        />
        <app-input-error [control]="documentForm.get('lastDosimetryDate')" />
      </div>
    }

    <!-- Campo Nombre de la Entidad -->
    @if (isFieldRequiredForDocumentType('epsName')) {
      <div>
        @if (currentDoc.idDocumentType == 135) {
          <app-select
            [items]="suraArlEntities"
            formControlName="epsName"
            placeholder="Nombre de la Entidad"
          >
          </app-select>
        } @else {
          <app-text-input
            [id]="'epsName'"
            formControlName="epsName"
            label="Nombre de la Entidad"
          />
        }
        <app-input-error [control]="documentForm.get('epsName')" />
      </div>
    }

    <!-- Campo Clasificación de Riesgo -->
    @if (isFieldRequiredForDocumentType('riskClassifier')) {
      <div>
        <app-select
          [items]="riskClassifierOptions"
          formControlName="riskClassifier"
          placeholder="Clasificación de Riesgo"
        >
        </app-select>
        <app-input-error [control]="documentForm.get('riskClassifier')" />
      </div>
    }

    <!-- Campo Nombre de Entidad -->
    @if (isFieldRequiredForDocumentType('resolutionOfThePension')) {
      <div>
        <app-text-input
          [id]="'resolutionOfThePension'"
          formControlName="resolutionOfThePension"
          label="Nombre de la Entidad"
        />
        <app-input-error [control]="documentForm.get('resolutionOfThePension')" />
      </div>
    }

    <!-- Campo Ciudad -->
    @if (isFieldRequiredForDocumentType('idCity')) {
      <div>
        <app-select
          [items]="citiesList"
          bindLabel="city"
          bindValue="idCity"
          [searchable]="true"
          formControlName="idCity"
          placeholder="Ciudad"
        >
        </app-select>
        <app-input-error [control]="documentForm.get('idCity')" />
      </div>
    }

    <!-- Campo Tipo de Prestador -->
    @if (isFieldRequiredForDocumentType('typePolicyProvider')) {
      <div>
        <app-select
          [items]="typePolicyProviderOptions"
          formControlName="typePolicyProvider"
          placeholder="Tipo de Prestador"
        >
        </app-select>
        <app-input-error [control]="documentForm.get('typePolicyProvider')" />
      </div>
    }

    <!-- Campo Valor Póliza / Monto -->
    @if (isFieldRequiredForDocumentType('amountPolicy')) {
      <div>
        <app-text-input
          [id]="'amountPolicy'"
          formControlName="amountPolicy"
          label="Valor Póliza"
          (onInput)="onAmountPolicyChange()"
          (onFocus)="amountPolicyInfoAlert(true)"
          [autocomplete]="'off'"
        />
        <app-input-error
          [control]="documentForm.get('amountPolicy')"
          [customMessages]="customErrorMessagesMap['amountPolicy']" />
        @if (hasAmountPolicyValidation()) {
          <a
            (click)="amountPolicyInfoAlert()"
            class="mt-1 inline-flex gap-1 items-center text-xs text-blue-600 dark:text-blue-500 hover:underline"
          >
            <svg width="16" height="16">
              <use xlink:href="/assets/icons/outline/general.svg#info-circle" />
            </svg>
            <span>Información importante</span>
          </a>
        }
      </div>
    }

    <!-- Campo documento -->
    <div class="flex flex-col gap-1.5 w-full">
      @if (loadedFile) {
        <span class="text-sm font-normal leading-4 text-gray-600">
          {{ loadedFile.name }}
        </span>
      }

      <label
        for="dropzone-file"
        appFileDrop
        [allowedExtensions]="clientSelected?.idClientHoneSolutions === 13 ? ['.pdf'] : []"
        [maxFileSizeMB]="7"
        (fileDropped)="loadFile($event)"
        class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer border-gray-300 bg-gray-50 hover:bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:hover:border-gray-500 dark:hover:bg-gray-600"
      >
        <div
          class="flex flex-col items-center justify-center pt-5 pb-6 text-gray-500 dark:text-gray-400 gap-[7px]"
        >
          <svg class="w-8 h-8 text-gray-400">
            <use xlink:href="/assets/icons/outline/general.svg#upload" />
          </svg>
          <p class="text-sm leading-4">
            <span class="font-semibold">Haz clic para cargar</span> o arrastra y
            suelta
          </p>
          <p class="text-xs leading-[14px]">
            {{ clientSelected?.idClientHoneSolutions === 13 ? 'Solo PDF' : ''}}
            (Máx. 7 MB)
          </p>
        </div>

        <input
          id="dropzone-file"
          type="file"
          name="file"
          class="hidden"
          appFileSelect
          [allowedExtensions]="clientSelected?.idClientHoneSolutions === 13 ? ['.pdf'] : []"
          [maxFileSizeMB]="7"
          (fileValidated)="loadFile($event)"
        />
      </label>

      @if (currentDoc.idDocumentType == 131) {
        <p class="text-xs text-gray-500 dark:text-gray-400">
          Debes de consolidar los certificados en un solo pdf.
        </p>
      }
    </div>
  </div>

  <div class="flex justify-end gap-2">
    <app-button
      (click)="closeModal()"
      variant="gray"
      styleType="soft"
      size="md"
      customClass="leading-4"
    >
      Cerrar
    </app-button>
    <app-button
      [type]="'submit'"
      [loading]="loader"
      variant="primary"
      size="md"
      styleType="solid"
      customClass="leading-4"
    >
      {{ isNew ? 'Guardar' : 'Actualizar' }}
    </app-button>
  </div>
</form>
